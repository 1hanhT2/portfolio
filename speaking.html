<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Speaking Practice • Bui Tan Thanh</title>
    <link rel="icon" type="image/svg+xml" href="./resources/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Base / tokens from main portfolio --- */
        :root {
            --bg: #0b0d12;
            --surface: #11161d;
            --surface-2: #0f141a;
            --text: #e5ecf5;
            --muted: #9fb0c3;
            --line: #263243;
            --accent: #7c5cff;
            --accent-2: #00d4ff;
            --ok: #3ae374;
            --warn: #f5a524;
            --danger: #ff5470;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35), 0 4px 8px rgba(0, 0, 0, .25);
        }

        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            letter-spacing: 0.2px;
            overflow-x: hidden;
        }
        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }
        img { max-width: 100%; display: block; }
        a { color: inherit; text-decoration: none; }
        .center { text-align: center; }
        .lead { color: var(--muted); font-size: 1.05rem; }
        .mt-2 { margin-top: .75rem; }

        /* --- Background Effects --- */
        .bg-wrap {
            position: fixed; inset: 0; z-index: -2; pointer-events: none; overflow: hidden;
            background: radial-gradient(1200px 700px at 10% -10%, rgba(124, 92, 255, .35), transparent 60%), radial-gradient(900px 600px at 85% 20%, rgba(0, 212, 255, .25), transparent 60%), radial-gradient(900px 700px at 50% 110%, rgba(255, 84, 112, .18), transparent 60%);
            filter: saturate(110%);
        }
        .bg-wrap::before {
            content: ""; position: absolute; inset: 0;
            background-image: radial-gradient(1px 1px at 15px 25px, white, transparent), radial-gradient(1px 1px at 75px 95px, white, transparent), radial-gradient(1px 1px at 135px 165px, white, transparent), radial-gradient(1px 1px at 45px 125px, white, transparent), radial-gradient(1px 1px at 185px 55px, white, transparent);
            background-size: 200px 200px; opacity: 0.3;
        }
        .stars { position: absolute; inset: -10vh -10vw; background: transparent; }
        .stars::before, .stars::after { content: ""; position: absolute; inset: 0; background-repeat: repeat; background-size: 300px 300px; opacity: .35; }
        .stars::before { background-image: radial-gradient(1px 1px at 20px 30px, #bbd1ff 50%, transparent 51%), radial-gradient(1px 1px at 140px 180px, #9bc9ff 50%, transparent 51%), radial-gradient(1px 1px at 240px 80px, #d6e2ff 50%, transparent 51%); }
        .stars::after { background-image: radial-gradient(1px 1px at 70px 60px, #cde0ff 50%, transparent 51%), radial-gradient(1px 1px at 200px 200px, #c3d9ff 50%, transparent 51%); opacity: .2; }

        /* --- Layout & Nav --- */
        .shell { width: min(1160px, 92vw); margin-inline: auto; }
        .nav {
            position: sticky; top: 14px; z-index: 50; display: flex; align-items: center; justify-content: space-between;
            gap: 12px; padding: 10px 14px; border-radius: 999px; backdrop-filter: blur(10px);
            background: color-mix(in oklab, var(--surface) 88%, transparent); box-shadow: var(--shadow);
            border: 1px solid color-mix(in oklab, var(--line) 80%, transparent); margin-bottom: 40px;
        }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .brand-dots { display: inline-flex; gap: 4px; }
        .brand-dots span { width: 8px; height: 8px; border-radius: 999px; display: block; background: linear-gradient(135deg, var(--accent), var(--accent-2)); filter: drop-shadow(0 0 6px rgba(124, 92, 255, .6)); }
        .nav-links { display: flex; align-items: center; gap: 8px; }
        .nav a { padding: 8px 12px; border-radius: 10px; color: var(--muted); }
        .nav a:hover { color: var(--text); background: linear-gradient(135deg, rgba(124, 92, 255, .12), rgba(0, 212, 255, .12)); }
        
        /* --- Buttons & Cards --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 14px;
            border-radius: 12px; font-weight: 600; border: 1px solid transparent;
            background: linear-gradient(var(--surface), var(--surface)) padding-box, linear-gradient(135deg, var(--accent), var(--accent-2)) border-box;
            color: var(--text);
            box-shadow: inset 0 -1px 0 rgba(255, 255, 255, .05), 0 6px 18px rgba(124, 92, 255, .25);
            transition: transform .2s ease, box-shadow .2s ease;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: inset 0 -1px 0 rgba(255, 255, 255, .06), 0 10px 26px rgba(124, 92, 255, .33); }
        .btn.secondary { background: linear-gradient(var(--surface), var(--surface)) padding-box, linear-gradient(135deg, #304055, #2b3240) border-box; }
        .btn:disabled { background: var(--surface-2); border-color: var(--line); color: var(--muted); cursor: not-allowed; box-shadow: none; transform: none; }
        
        .card {
            position: relative;
            background: linear-gradient(180deg, color-mix(in oklab, var(--surface) 92%, transparent), color-mix(in oklab, var(--surface-2) 92%, transparent));
            border: 1px solid var(--line); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow);
            text-align: center;
        }
        
        /* --- Audio Recorder Styles --- */
        .app-container {
            max-width: 550px;
            margin: 40px auto;
        }
        .app-container h1 {
            font-size: clamp(1.6rem, 2.6vw, 2rem);
            background: linear-gradient(90deg, var(--text), #c7d2fe 30%, #a5b4fc 60%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        .app-container h2 {
            margin-top: 0;
            color: var(--text);
        }
        .app-container p {
            color: var(--muted);
            margin: 8px 0 16px;
        }
        .app-section {
            padding: 15px;
            border-radius: var(--radius);
        }
        #name-section, #wait-section, #record-section, #download-section, #error-section {
            display: none; /* Hide all by default, JS will manage visibility */
        }
        #name-section.active {
            display: block;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--muted);
        }
        input[type="text"] {
            width: 100%;
            color: var(--text);
            background: var(--surface-2);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px 12px;
            outline: none;
            transition: border-color .2s ease, box-shadow .2s ease;
            font-family: inherit;
            font-size: inherit;
            margin-bottom: 16px;
        }
        input[type="text"]:focus-visible {
            box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 60%, transparent);
            border-color: color-mix(in oklab, var(--accent) 60%, var(--line));
        }
        .timer-display, #random-number-display {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-2);
            margin: 12px 0;
        }
        #status-message.recording {
            color: var(--danger);
            animation: blink 1.2s ease-in-out infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* --- Footer & Cursor --- */
        .footer { color: var(--muted); padding: 40px 0 70px; text-align: center; }
        .cursor-blob { position: fixed; top: 0; left: 0; width: 260px; height: 260px; border-radius: 50%; pointer-events: none; z-index: -1; background: radial-gradient(closest-side, rgba(124, 92, 255, .22), rgba(0, 212, 255, .12), transparent 60%); filter: blur(30px); transform: translate(-50%, -50%); mix-blend-mode: screen; opacity: .7; }
        @media (max-width: 900px), (pointer: coarse) { .cursor-blob { display: none; } }
    </style>
</head>
<body>
    <div class="bg-wrap" aria-hidden="true">
        <div class="stars"></div>
    </div>
    <div class="cursor-blob" id="blob" aria-hidden="true"></div>

    <main class="shell">
        <nav class="nav">
            <a class="brand" href="index.html">
                <span class="brand-dots"><span></span><span></span><span></span><span></span></span>
                <span>Bui Tan Thanh</span>
            </a>
            <div class="nav-links">
                <a href="index.html#journey">Journey</a>
                <a href="index.html#achievements">Achievements</a>
                <a href="index.html#features">Features</a>
                <a href="index.html">Back to Main</a>
                <a class="btn" href="index.html#contact">Get in touch</a>
            </div>
        </nav>

        <div class="app-container card">
            <h1>Speaking Practice</h1>

            <div id="name-section" class="app-section active">
                <label for="user-name">Please enter your name:</label>
                <input type="text" id="user-name" name="user-name" placeholder="Your Name">
                <button id="start-button" class="btn">Start Process</button>
            </div>

            <div id="wait-section" class="app-section">
                <h2>Get Ready!</h2>
                <p>Your number is: <span id="random-number-display"></span></p>
                <p>Recording will start in:</p>
                <div id="wait-timer-display" class="timer-display">--:--</div>
                <p style="font-size: .9em;">(Microphone access will be requested after this timer)</p>
            </div>

            <div id="record-section" class="app-section">
                <h2>Recording</h2>
                <p id="status-message">Initializing...</p>
                <p>Time remaining:</p>
                <div id="record-timer-display" class="timer-display">--:--</div>
            </div>

            <div id="download-section" class="app-section">
                <h2>Recording Complete!</h2>
                <p>Your audio file is ready for download.</p>
                <a href="#" id="download-link" download="recording.webm" class="btn secondary mt-2">Download Recording</a>
                <p style="font-size: 0.8em; margin-top: 15px;">(You can now close this page or start again by refreshing)</p>
            </div>

            <div id="error-section" class="app-section">
                <h2>Error</h2>
                <p id="error-message" style="color: var(--danger);"></p>
            </div>
        </div>

        <footer class="footer">© <span id="year"></span> Bui Tan Thanh</footer>
    </main>

    <script>
        // --- Year
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- Cursor blob
        const blobEl = document.getElementById('blob');
        let bx = window.innerWidth / 2, by = window.innerHeight / 2;
        window.addEventListener('pointermove', (e) => { bx = e.clientX; by = e.clientY; }, { passive: true });
        const tick = () => {
            const curX = parseFloat(blobEl.style.left || bx), curY = parseFloat(blobEl.style.top || by);
            blobEl.style.left = (curX + (bx - curX) * 0.12) + 'px';
            blobEl.style.top  = (curY + (by - curY) * 0.12) + 'px';
            requestAnimationFrame(tick);
        };
        tick();

        // --- Audio Recorder App Logic ---
        const WAIT_DURATION_SECONDS = 300; 
        const RECORD_DURATION_SECONDS = 300; 

        const sections = {
            name: document.getElementById('name-section'),
            wait: document.getElementById('wait-section'),
            record: document.getElementById('record-section'),
            download: document.getElementById('download-section'),
            error: document.getElementById('error-section'),
        };

        const userNameInput = document.getElementById('user-name');
        const startButton = document.getElementById('start-button');
        const randomNumberDisplay = document.getElementById('random-number-display');
        const waitTimerDisplay = document.getElementById('wait-timer-display');
        const recordTimerDisplay = document.getElementById('record-timer-display');
        const statusMessage = document.getElementById('status-message');
        const downloadLink = document.getElementById('download-link');
        const errorMessage = document.getElementById('error-message');

        let userName = '';
        let randomNumber = 0;
        let waitIntervalId = null;
        let recordIntervalId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioStream = null;

        function showSection(sectionName) {
            Object.values(sections).forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            if (sections[sectionName]) {
                sections[sectionName].style.display = 'block';
                sections[sectionName].classList.add('active');
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function displayError(message) {
            console.error("Error:", message);
            errorMessage.textContent = message;
            showSection('error');
            // Clean up any running timers/processes
            clearInterval(waitIntervalId);
            clearInterval(recordIntervalId);
            if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
            if (audioStream) audioStream.getTracks().forEach(track => track.stop());
        }

        function startWaitTimer() {
            let timeLeft = WAIT_DURATION_SECONDS;
            waitTimerDisplay.textContent = formatTime(timeLeft);
            waitIntervalId = setInterval(() => {
                timeLeft--;
                waitTimerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(waitIntervalId);
                    startRecordingProcess();
                }
            }, 1000);
        }

        async function startRecordingProcess() {
            showSection('record');
            statusMessage.textContent = 'Requesting microphone access...';
            statusMessage.classList.remove('recording');

            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                statusMessage.textContent = 'Microphone accessed. Starting recording...';
                mediaRecorder = new MediaRecorder(audioStream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    clearInterval(recordIntervalId);
                    statusMessage.textContent = 'Recording finished. Processing audio...';
                    statusMessage.classList.remove('recording');

                    if (audioChunks.length === 0) {
                        displayError("No audio data was recorded. Please check microphone permissions and try again.");
                        return;
                    }

                    const mimeType = mediaRecorder.mimeType || 'audio/webm';
                    const fileExtension = mimeType.split('/')[1].split(';')[0];
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    downloadLink.href = audioUrl;
                    const safeUserName = userName.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'user';
                    downloadLink.download = `recording-${safeUserName}-num${randomNumber}.${fileExtension}`;

                    showSection('download');
                    if (audioStream) audioStream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.onerror = (event) => displayError(`Recording error: ${event.error.name} - ${event.error.message}`);

                mediaRecorder.start();
                statusMessage.textContent = 'RECORDING';
                statusMessage.classList.add('recording');
                startRecordTimer();

                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
                }, RECORD_DURATION_SECONDS * 1000);

            } catch (err) {
                console.error("Error accessing media devices:", err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    displayError('Microphone access denied. Please allow microphone access in your browser settings and refresh the page.');
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    displayError('No microphone found. Please ensure a microphone is connected and enabled.');
                } else {
                    displayError(`Could not access microphone: ${err.name} - ${err.message}`);
                }
            }
        }

        function startRecordTimer() {
            let timeLeft = RECORD_DURATION_SECONDS;
            recordTimerDisplay.textContent = formatTime(timeLeft);
            recordIntervalId = setInterval(() => {
                timeLeft--;
                recordTimerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft < 0) clearInterval(recordIntervalId);
            }, 1000);
        }

        startButton.addEventListener('click', () => {
            userName = userNameInput.value.trim();
            if (!userName) {
                alert('Please enter your name.');
                userNameInput.focus();
                return;
            }
            startButton.disabled = true;
            userNameInput.disabled = true;
            randomNumber = Math.floor(Math.random() * 10) + 1;
            randomNumberDisplay.textContent = randomNumber;
            showSection('wait');
            startWaitTimer();
        });

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            displayError('Your browser does not support the MediaRecorder API. Please use a modern browser like Chrome or Firefox.');
        } else {
            showSection('name');
        }
    </script>
</body>
</html>
